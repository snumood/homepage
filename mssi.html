<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>기분안정성평가 - 분당서울대학교병원 기분장애클리닉</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    /* =========================================
       1. 홈페이지 네비게이션 바 스타일 (파란색 테마)
       ========================================= */
    :root {
      /* 네비게이션용 변수 (기존 폼 변수와 충돌 방지 위해 별도 지정) */
      --nav-primary: #0d47a1; 
      --nav-dark: #002171;
      --nav-light-bg: #e3f2fd;
      --nav-text: #212121;
      --nav-text-light: #5a5a5a;
      --nav-white: #ffffff;
      --nav-border: #e0e0e0;
      --nav-secondary: #42a5f5;

      /* 기존 설문지용 변수 (보라색 테마 유지) */
      --form-primary: #4F46E5; 
      --form-primary-light: #EEF2FF; 
      --form-text: #1F2937;
      --form-gray: #6B7280; 
      --form-bg: #F9FAFB; 
      --form-card-bg: #FFFFFF;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
      background-color: var(--form-bg); 
      color: var(--form-text); 
      line-height: 1.5; 
      padding-top: 90px; /* 네비게이션 바 높이만큼 여백 확보 */
    }

    /* --- 네비게이션 바 CSS 시작 --- */
    #main-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: var(--nav-white);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
        z-index: 1000;
        display: flex;
        justify-content: center;
        height: 70px;
    }

    .header-container {
        width: 100%;
        max-width: 1200px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 25px;
    }

    .logo {
        font-size: 1.15rem;
        font-weight: 700;
        color: var(--nav-dark);
        text-decoration: none;
        letter-spacing: -0.5px;
        white-space: nowrap;
    }

    #main-nav { display: flex; }
    #main-nav ul { display: flex; list-style: none; }
    #main-nav li { margin-left: 20px; }

    #main-nav a {
        text-decoration: none;
        color: var(--nav-text-light);
        font-weight: 600;
        font-size: 0.9rem;
        padding: 24px 0;
        border-bottom: 3px solid transparent;
        transition: color 0.3s, border-color 0.3s;
        white-space: nowrap;
    }
    
    #main-nav a:hover,
    #main-nav a.active {
        color: var(--nav-primary);
        border-bottom-color: var(--nav-secondary);
    }

    #mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        cursor: pointer;
        z-index: 1001;
        padding: 10px;
    }

    #mobile-menu-toggle .bar {
        display: block;
        width: 25px;
        height: 3px;
        background-color: var(--nav-primary);
        margin: 5px 0;
        transition: all 0.3s ease-in-out;
        border-radius: 2px;
    }

    /* 반응형 네비게이션 */
    @media (max-width: 1024px) {
        .logo { font-size: 1rem; }
        
        #main-nav {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            height: calc(100vh - 70px);
            background: var(--nav-white);
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            border-top: 1px solid var(--nav-border);
            overflow-y: auto;
        }

        #main-nav.is-active { transform: translateX(0); }
        #main-nav ul { flex-direction: column; align-items: flex-start; width: 100%; }
        #main-nav li { margin: 0; width: 100%; }
        
        #main-nav a {
            font-size: 1.1rem;
            padding: 16px 25px;
            display: block;
            border-bottom: 1px solid var(--nav-border);
        }
        
        #main-nav a:hover,
        #main-nav a.active {
            background-color: var(--nav-light-bg);
            color: var(--nav-primary);
            border-bottom-color: var(--nav-border);
        }

        #mobile-menu-toggle { display: block; }

        #mobile-menu-toggle.is-active .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
        #mobile-menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        #mobile-menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

        #main-header { height: 60px; }
        #main-nav { top: 60px; height: calc(100vh - 60px); }
        body { padding-top: 80px; }
    }
    /* --- 네비게이션 바 CSS 끝 --- */


    /* =========================================
       2. MSSI 설문지 스타일 (보라색 테마)
       ========================================= */
    .container { max-width: 720px; margin: 0 auto; padding: 0 16px; }
    
    /* 기존 header 태그를 .form-header 클래스로 변경하여 스타일 충돌 방지 */
    .form-header { 
      text-align: left; 
      margin-bottom: 24px; 
      padding: 24px; 
      background: var(--form-card-bg); 
      border-radius: 16px; 
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
    }
    
    h1.form-title { font-size: 1.5rem; font-weight: 700; color: var(--form-text); margin: 0 0 12px 0; }
    .instruction-box { background: #fdfdfd; padding: 15px; border-left: 4px solid var(--form-primary); font-size: 0.9rem; color: #444; margin-top: 10px; }
    
    .patient-info-card { background: var(--form-card-bg); border-radius: 16px; padding: 24px; margin-bottom: 20px; border: 2px solid var(--form-primary-light); }
    .input-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; }
    .text-input { width: 100%; padding: 14px; border-radius: 12px; border: 2px solid #E5E7EB; font-size: 1rem; }

    .question-card { background: var(--form-card-bg); border-radius: 16px; padding: 24px 20px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    .question-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; }
    .question-number { color: var(--form-primary); font-weight: 800; margin-right: 8px; }
    
    .gate-question { display: flex; gap: 12px; margin-bottom: 10px; }
    .gate-label { flex: 1; display: block; padding: 14px; border: 2px solid #E5E7EB; border-radius: 12px; cursor: pointer; text-align: center; font-weight: 600; }
    .gate-radio { display: none; }
    .gate-radio:checked + .gate-label { border-color: var(--form-primary); background-color: var(--form-primary-light); color: var(--form-primary); }
    
    .sub-questions { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px dashed #E5E7EB; }
    .sub-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 12px; color: #555; }
    .options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .option-label { display: flex; align-items: center; padding: 12px 16px; background: var(--form-bg); border-radius: 10px; cursor: pointer; font-size: 0.9rem; }
    .option-radio { margin-right: 12px; width: 18px; height: 18px; }
    .option-label:has(.option-radio:checked) { background: var(--form-primary-light); color: var(--form-primary); font-weight: 600; }

    .btn-submit { width: 100%; padding: 18px; background: var(--form-primary); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 20px; }
    
    #result { display: none; background: white; padding: 30px 20px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-top: 20px; }
    .rank-box { background: #f8fafc; padding: 20px; border-radius: 15px; margin-top: 20px; text-align: left; line-height: 1.7; border: 1px solid #e2e8f0; }
    .highlight { color: var(--form-primary); font-weight: 700; }
  </style>
</head>
<body>

  <header id="main-header">
    <div class="header-container">
        <a href="https://snumood.github.io/homepage/" class="logo">분당서울대학교병원 기분장애클리닉</a>
        <nav id="main-nav">
            <ul>
                <li><a href="https://snumood.github.io/homepage/#surveys">설문지 작성</a></li>
                <li><a href="https://snumood.github.io/homepage/#results">설문결과 확인</a></li>
                <li><a href="https://snumood.github.io/homepage/#lifestyle-score">생활습관 점수표</a></li>
                
                <li><a href="https://snumood.github.io/homepage/mssi.html" class="active">기분안정성평가 설문지</a></li>
                
                <li><a href="https://snumood.github.io/homepage/#mood-chart">기분 기록지</a></li>
                <li><a href="https://snumood.github.io/homepage/#relaxation">마음안정화 훈련 (호흡/이완)</a></li>
                <li><a href="https://snumood.github.io/homepage/#mindfulness">마음챙김</a></li>
                <li><a href="https://snumood.github.io/homepage/#workbook">워크북</a></li>
                <li><a href="https://snumood.github.io/homepage/#research">연구 성과</a></li>
            </ul>
        </nav>
        <button id="mobile-menu-toggle" aria-label="메뉴 열기">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>
    </div>
  </header>

  <div class="container">
    <div class="form-header">
      <h1 class="form-title">기분안정성평가</h1>
      <div class="instruction-box">
        당신의 최근 2주 동안의 모습을 알아보는 검사입니다. 증상이 지난 2주간 있었으면 <strong>"예"</strong>라고 답해 주시고, 각 문항마다 <strong>증상의 빈도(A)</strong>와 <strong>심한 정도(B)</strong>를 표시해 주십시오. 2주간 증상이 없었다면 <strong>"아니오"</strong>로 답한 뒤 다음 문항으로 넘어가 주십시오.
      </div>
    </div>

    <form id="mssiForm">
      <div class="patient-info-card">
        <label class="input-label">등록번호 또는 이니셜+생년월일</label>
        <input type="text" id="patientID" class="text-input" placeholder="예: 43445678 또는 HGD19990305" required>
      </div>

      <div id="questions-container"></div>

      <div class="question-card">
        <div class="question-title"><span class="question-number">21</span>우울하더라도 행동이 느려지진 않았다.</div>
        <div class="gate-question">
          <input type="radio" name="q21_gate" value="0" class="gate-radio" id="q21_no"><label for="q21_no" class="gate-label">(0) 아니오 (느려졌다)</label>
          <input type="radio" name="q21_gate" value="1" class="gate-radio" id="q21_yes"><label for="q21_yes" class="gate-label">(1) 예 (느려지지 않았다)</label>
        </div>
      </div>

      <button type="submit" id="submitBtn" class="btn-submit">결과 제출하기</button>
    </form>

    <div id="result">
      <h2 style="margin-top:0">검사 결과</h2>
      <div style="font-size:1.2rem">나의 기분안정성 점수: <span id="totalScore" class="highlight" style="font-size:2rem">0</span>점</div>
      <div id="rankResult" class="rank-box"></div>
      <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; border-radius:10px; border:none; background:#94a3b8; color:white; cursor:pointer">다시 검사하기</button>
    </div>
  </div>

  <script>
    // --- 1. 네비게이션 동작 스크립트 ---
    document.addEventListener('DOMContentLoaded', function () {
        const menuToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('main-nav');
        const navLinks = navMenu.querySelectorAll('a');

        menuToggle.addEventListener('click', function () {
            menuToggle.classList.toggle('is-active');
            navMenu.classList.toggle('is-active');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', function () {
                if (navMenu.classList.contains('is-active')) {
                    menuToggle.classList.remove('is-active');
                    navMenu.classList.remove('is-active');
                }
            });
        });
    });

    // --- 2. MSSI 설문 동작 스크립트 ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_yBTRXkpfi-v8ypI0FK6Mwg8CZeiNjD6VpnTgW-U75_J2crv7Twk09WupnREs_RoA/exec';

    const questions = [
      "감정 기복이 있었다.", "기분이 불안정했다.", "다른 사람들과 다투는 일이 있었다.", "화가 나고 짜증이 났다.",
      "사소한 자극에도 눈물이 나거나 우는 날이 많았다.", "사소한 일에도 흥분되었다.", "기분이 들뜨기도 했다.", "평안하다고 느낀 적이 없다.",
      "불안하고 초조했다.", "갑자기 에너지가 생겨 할 일을 정하고 행동으로 옮기기도 했다.", "말이 많고 빨라졌다.", "생각이 많아서 잠들기 힘들었다.",
      "생각이 꼬리에 꼬리를 물고 이어졌다.", "의기양양하거나 과대한 기분을 느꼈다.", "긴장감을 느꼈다.", "잠에 들 생각을 못한 채 밤을 새거나 늦게 잤다.",
      "나에게 안 좋은 결과를 가져올 것을 알고도 몰입하는 것이 있었다.", "죽고 싶다는 생각이 들었다.", "충동적으로 모든 일을 그만두고 싶어졌다.", "자해를 하고 싶다는 생각이 들었다."
    ];

    const container = document.getElementById('questions-container');
    questions.forEach((q, i) => {
      const n = i + 1;
      container.innerHTML += `
        <div class="question-card" id="card_q${n}">
          <div class="question-title"><span class="question-number">${n}</span>${q}</div>
          <div class="gate-question">
            <input type="radio" name="q${n}_gate" value="0" class="gate-radio" id="q${n}_no"><label for="q${n}_no" class="gate-label">(0) 아니오</label>
            <input type="radio" name="q${n}_gate" value="1" class="gate-radio" id="q${n}_yes"><label for="q${n}_yes" class="gate-label">(1) 예</label>
          </div>
          <div class="sub-questions" id="sq-q${n}">
            <div class="sub-title">A. 얼마나 자주 있었습니까? (증상의 빈도)</div>
            <div class="options">
              ${[1,2,3,4].map(v => `<label class="option-label"><input type="radio" name="q${n}_freq" value="${v}" class="option-radio"><span>(${v}) ${["1일 미만(몇 시간 지속)","1일 이상 1주 미만","1주 이상 2주 미만","매일 증상이 있었다"][v-1]}</span></label>`).join('')}
            </div>
            <div class="sub-title">B. 얼마나 심했습니까? (증상의 심한 정도)</div>
            <div class="options">
              ${[1,2,3].map(v => `<label class="option-label"><input type="radio" name="q${n}_sev" value="${v}" class="option-radio"><span>(${v}) ${["약간 (증상은 있었지만 힘들지 않았다)","상당히 (매우 불쾌하지만 참을 수 있었다)","심하게 (정말 견디기 힘들었다)"][v-1]}</span></label>`).join('')}
            </div>
          </div>
        </div>`;
    });

    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('gate-radio')) {
        const qNum = e.target.name.split('_')[0];
        const subDiv = document.getElementById(`sq-${qNum}`);
        if (e.target.value === '1') {
          subDiv.style.display = 'block';
        } else {
          subDiv.style.display = 'none';
          subDiv.querySelectorAll('input').forEach(r => r.checked = false);
        }
      }
    });

    function normDist(x, mean, std) {
      return (1 + erf((x - mean) / (Math.sqrt(2) * std))) / 2;
    }
    function erf(x) {
      const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
      const sign = (x < 0) ? -1 : 1; x = Math.abs(x);
      const t = 1.0 / (1.0 + p * x);
      const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
      return sign * y;
    }

    document.getElementById('mssiForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      for(let i=1; i<=21; i++) {
        const gate = document.querySelector(`input[name="q${i}_gate"]:checked`);
        if(!gate) {
          alert(`${i}번 문항의 "예/아니오"를 선택해 주세요.`);
          document.getElementById(`card_q${i}`)?.scrollIntoView({behavior:'smooth'});
          return;
        }
        if(gate.value === '1' && i <= 20) {
          const f = document.querySelector(`input[name="q${i}_freq"]:checked`);
          const s = document.querySelector(`input[name="q${i}_sev"]:checked`);
          if(!f || !s) {
            alert(`${i}번 문항의 빈도와 심한 정도를 모두 선택해 주세요.`);
            return;
          }
        }
      }

      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = "제출 중...";

      let totalScore = 0;
      const answers = {};
      const pID = document.getElementById('patientID').value;

      for (let i = 1; i <= 20; i++) {
        const gVal = document.querySelector(`input[name="q${i}_gate"]:checked`).value;
        let fText = "", sText = "";
        if (gVal === '1') {
          const fEl = document.querySelector(`input[name="q${i}_freq"]:checked`);
          const sEl = document.querySelector(`input[name="q${i}_sev"]:checked`);
          totalScore += (parseInt(fEl.value) * parseInt(sEl.value));
          fText = fEl.parentElement.textContent.trim();
          sText = sEl.parentElement.textContent.trim();
        }
        answers["q"+i] = { gate: gVal==='1'?"1. 예":"0. 아니오", freq: fText, sev: sText };
      }
      const q21Val = document.querySelector(`input[name="q21_gate"]:checked`).value;
      answers["q21"] = q21Val === '1' ? "1. 예" : "0. 아니오";

      const rankPatient = Math.round((1 - normDist(totalScore, 50.0308, 37.18785)) * 100);
      const rankNormal = Math.round((1 - normDist(totalScore, 30, 20)) * 100);

      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST', mode: 'no-cors',
          body: JSON.stringify({ patientID: pID, totalScore, answers })
        });
        
        document.getElementById('mssiForm').style.display = 'none';
        document.getElementById('result').style.display = 'block';
        document.getElementById('totalScore').textContent = totalScore;
        document.getElementById('rankResult').innerHTML = `
          당신의 기분안정성 점수는 <span class="highlight">${totalScore}점</span>입니다. 점수가 높을수록 기분이 불안정한 상태를 의미합니다.<br><br>
          점수는 최저 0점, 최고 240점, 기분장애클리닉환자의 평균점수는 50점, 정신건강의학과에 방문하지 않는 분들의 평균점수는 30점 정도입니다.<br>
          당신의 점수는 분당서울대학교병원 기분장애클리닉 환자 100명 중에 <span class="highlight">${rankPatient}등</span>,<br>
          정신건강의학과에 방문하지 않는 사람들 100명 중에 <span class="highlight">${rankNormal}등</span> 정도의 점수입니다.
        `;
        window.scrollTo(0,0);
      } catch (err) {
        alert("저장 중 오류가 발생했습니다. 다시 시도해 주세요.");
        btn.disabled = false; btn.textContent = "다시 제출하기";
      }
    });
  </script>
</body>
</html>
